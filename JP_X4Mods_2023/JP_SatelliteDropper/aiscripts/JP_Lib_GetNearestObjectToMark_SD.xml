<?xml version="1.0" encoding="utf-8"?>

<!-- Script uses these Parameters !!
~~~~~~~~~~~~~
$JUMP_GATES
$ACTIVE_JUMP_GATES
$INACTIVE_JUMP_GATES
$ACCELERATORS
$ACTIVE_ACCELERATORS
$INACTIVE_ACCELERATOR
~~~~~~~~~~~~~
$STATIONS
$WHARFS
$SHIPYARDS
$PIRATE_BASES
$EQUIPMENTDOCKS
$TRADING_STATIONS
$DEFENCE_STATIONS
$FACTION_HEADQUARTERS
$NON_SPECIAL_STATIONS
~~~~~~~~~~~~~
$SECTOR ~~ if null the script searches the galaxy else this SECTOR
$DEBUG
~~~~~~~~~~~~~
$Ship
$DebugFolderName
~~~~~~~~~~~~~
-->

<!-- Return parameter ~~ null if nothing found
$_FoundObjects
-->

<aiscript name="JP_Lib_GetNearestObjectToMark_SD" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd">

   <interrupts>
      <library>
         <actions name="JP_Lib_GetNearestObjectToMark_SD">

            <set_value name="$_DebugScriptName" exact="'JP_Lib_GetNearestObjectToMark_SD'"/>
            <set_value name="$_DebugFileName" exact="$Ship.idcode + '.' + $_DebugScriptName + '.xml.log'"/>

            <do_if value="$DEBUG gt 0">
               <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'" append="false"/>
               <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ ' + $_DebugScriptName + '.xml ~ Started ~~' + '\n'"/>
            </do_if>

            <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

            <include_interrupt_actions ref="GetBlacklistgroup"/>

            <!-- If $SECTOR is null we search the galaxy else only $SECTOR -->
            <create_list name="$_Sectors"/>
            <do_if value="$SECTOR == null">
               <find_sector name="$_Sectors" space="player.galaxy" multiple="true">
                  <match knownto="$Ship.owner"/>
                  <match_gate_distance object="$Ship" min="0"/>
                  <!-- only sectors we can reach -->
                  <match_use_blacklist object="$Ship" type="blacklisttype.sectortravel" group="$blacklistgroup"/>
                  <match_use_blacklist object="$Ship" type="blacklisttype.sectoractivity" group="$blacklistgroup"/>
                  <match_use_blacklist object="$Ship" type="blacklisttype.objectactivity" group="$blacklistgroup"/>
               </find_sector>
               <do_if value="$_Sectors.count gt 1">
                  <sort_list list="$_Sectors" sortbyvalue="$Ship.gatedistance.{loop.element}"/>
               </do_if>
            </do_if>
            <do_else>
               <append_to_list name="$_Sectors" exact="$SECTOR"/>
            </do_else>

            <do_if value="$DEBUG gt 0">
               <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
               <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'$_Sectors.count: ' + $_Sectors.count"/>
               <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
               <do_for_each name="$_Sector" in="$_Sectors">
                  <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'$_Sector: ' + $_Sector.knownname + ' ~ ' + $Ship.gatedistance.{$_Sector}"/>
               </do_for_each>
               <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n'"/>
            </do_if>

            <do_for_each name="$_Sector" in="$_Sectors">

               <create_list name="$_FoundObjects"/>

               <do_if value="$JUMP_GATES">
                  <do_if value="$ACTIVE_JUMP_GATES">
                     <find_object name="$_FoundObjects" space="$_Sector" multiple="true" append="true">
                        <match knownto="$Ship.owner"/>
                        <match active="true"/>
                        <match macro="[macro.props_gates_anc_gate_macro, macro.props_gates_anc_gate_anim_macro, macro.props_ter_gate_01_macro]"/>
                        <match_use_blacklist object="$Ship" type="blacklisttype.sectoractivity" group="$blacklistgroup"/>
                     </find_object>
                  </do_if>
                  <do_if value="$INACTIVE_JUMP_GATES">
                     <find_object name="$_FoundObjects" space="$_Sector" multiple="true" append="true">
                        <match knownto="$Ship.owner"/>
                        <match active="false"/>
                        <match macro="[macro.props_gates_anc_gate_macro, macro.props_gates_anc_gate_anim_macro, macro.props_ter_gate_01_macro]"/>
                        <match_use_blacklist object="$Ship" type="blacklisttype.sectoractivity" group="$blacklistgroup"/>
                     </find_object>
                  </do_if>
               </do_if>

               <do_if value="$ACCELERATORS">
                  <do_if value="$ACTIVE_ACCELERATORS">
                     <find_object name="$_FoundObjects" space="$_Sector" multiple="true" append="true">
                        <match knownto="$Ship.owner"/>
                        <match active="true"/>
                        <match macro="[macro.props_gates_orb_accelerator_01_macro]"/>
                        <match_use_blacklist object="$Ship" type="blacklisttype.sectoractivity" group="$blacklistgroup"/>
                     </find_object>
                  </do_if>
                  <do_if value="$INACTIVE_ACCELERATORS">
                     <find_object name="$_FoundObjects" space="$_Sector" multiple="true" append="true">
                        <match knownto="$Ship.owner"/>
                        <match active="false"/>
                        <match macro="[macro.props_gates_orb_accelerator_01_macro]"/>
                        <match_use_blacklist object="$Ship" type="blacklisttype.sectoractivity" group="$blacklistgroup"/>
                     </find_object>
                  </do_if>
               </do_if>

               <do_if value="$SUPER_HIGHWAYS">
                  <do_if value="$ACTIVE_SUPER_HIGHWAYS">
                     <find_object name="$_FoundObjects" space="$_Sector" multiple="true" append="true">
                        <match knownto="$Ship.owner"/>
                        <match active="true"/>
                        <match macro="[macro.he_gen_superhighway_entrance_01_macro, macro.he_gen_superhighway_exit_01_macro]"/>
                        <match_use_blacklist object="$Ship" type="blacklisttype.sectoractivity" group="$blacklistgroup"/>
                     </find_object>
                  </do_if>
                  <do_if value="$INACTIVE_SUPER_HIGHWAYS">
                     <find_object name="$_FoundObjects" space="$_Sector" multiple="true" append="true">
                        <match knownto="$Ship.owner"/>
                        <match active="false"/>
                        <match macro="[macro.he_gen_superhighway_entrance_01_macro, macro.he_gen_superhighway_exit_01_macro]"/>
                        <match_use_blacklist object="$Ship" type="blacklisttype.sectoractivity" group="$blacklistgroup"/>
                     </find_object>
                  </do_if>
               </do_if>

               <do_if value="$STATIONS">
                  <create_list name="$_Stations"/>
                  <find_station name="$_Stations" space="$_Sector" multiple="true">
                     <match knownto="$Ship.owner"/>
                     <match_use_blacklist object="$Ship" type="blacklisttype.sectoractivity" group="$blacklistgroup"/>
                  </find_station>
                  <do_for_each name="$_Station" in="$_Stations">
                     <do_if value="$_Station.iswharf and $WHARFS">
                        <append_to_list name="$_FoundObjects" exact="$_Station"/>
                        <continue/>
                     </do_if>
                     <do_if value="$_Station.isshipyard and $SHIPYARDS">
                        <append_to_list name="$_FoundObjects" exact="$_Station"/>
                        <continue/>
                     </do_if>
                     <do_if value="$_Station.isequipmentdock and $EQUIPMENTDOCKS">
                        <append_to_list name="$_FoundObjects" exact="$_Station"/>
                        <continue/>
                     </do_if>
                     <do_if value="$_Station.istradestation and $TRADING_STATIONS">
                        <append_to_list name="$_FoundObjects" exact="$_Station"/>
                        <continue/>
                     </do_if>
                     <do_if value="$_Station.ispiratebase and $PIRATE_BASES">
                        <append_to_list name="$_FoundObjects" exact="$_Station"/>
                        <continue/>
                     </do_if>
                     <do_if value="$_Station.isrecyclingfacility and $RECYCLING_STATIONS">
                        <append_to_list name="$_FoundObjects" exact="$_Station"/>
                        <continue/>
                     </do_if>
                     <do_if value="$_Station.isdefencestation and not $_Station.iswharf and not $_Station.isshipyard and not $_Station.isequipmentdock and not $_Station.istradestation and not $_Station.ispiratebase and not $_Station.isfactionheadquarters and $DEFENCE_STATIONS">
                        <append_to_list name="$_FoundObjects" exact="$_Station"/>
                        <continue/>
                     </do_if>
                     <do_if value="$_Station.isfactionheadquarters and $FACTION_HEADQUARTERS">
                        <append_to_list name="$_FoundObjects" exact="$_Station"/>
                        <continue/>
                     </do_if>
                     <do_if value="$_Station.iswharf == false and
                                   $_Station.isshipyard == false and
                                   $_Station.isequipmentdock == false and
                                   $_Station.istradestation == false and
                                   $_Station.ispiratebase == false and
                                   $_Station.isrecyclingfacility == false and
                                   $_Station.isdefencestation == false and
                                   $_Station.isfactionheadquarters == false and
                                   $NON_SPECIAL_STATIONS">
                        <append_to_list name="$_FoundObjects" exact="$_Station"/>
                        <continue/>
                     </do_if>
                  </do_for_each>
                  <remove_value name="$_Stations"/>
               </do_if>

               <create_list name="$_AlreadyMarked"/>
               <do_for_each name="$_FoundObject" in="$_FoundObjects">
                  <create_list name="$_FoundSatellites"/>
                  <find_object space="$_FoundObject.sector" name="$_FoundSatellites" multiple="true">
                     <match owner="$Ship.owner"/>
                     <match deployablecategory="deployablecategory.satellite"/>
                  </find_object>
                  <do_if value="$_FoundSatellites.count gt 0">
                     <do_for_each name="$_FoundSatellite" in="$_FoundSatellites">
                        <do_if value="$_FoundObject.distanceto.{$_FoundSatellite} lt ($_FoundSatellite.maxradarrange * 0.98)">
                           <append_to_list name="$_AlreadyMarked" exact="$_FoundObject"/>
                           <break/>
                        </do_if>
                     </do_for_each>
                  </do_if>
                  <remove_value name="$_FoundSatellites"/>
               </do_for_each>
               <remove_from_list name="$_FoundObjects" list="$_AlreadyMarked"/>
               <remove_value name="$_AlreadyMarked"/>

               <!-- sort and get nearest -->
               <do_if value="$_FoundObjects.count gt 0">
                  <do_if value="$_FoundObjects.count gt 1">
                     <sort_list list="$_FoundObjects" sortbyvalue="$Ship.distanceto.{loop.element}"/>
                  </do_if>
                  <do_if value="$DEBUG gt 0">
                     <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
                     <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'$_Sector.knownname: ' + $_Sector.knownname"/>
                     <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'$_FoundObjects.count: ' + $_FoundObjects.count"/>
                     <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
                     <do_for_each name="$_FoundObject" in="$_FoundObjects">
                        <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'$_FoundObject: ' + $_FoundObject.knownname + ' ~ ' + $_FoundObject.class + ' ~ ' + $_FoundObject.position"/>
                     </do_for_each>
                     <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n'"/>
                  </do_if>
                  <break/>
               </do_if>
            </do_for_each>

            <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

            <do_if value="$DEBUG gt 0">
               <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ ' + $_DebugScriptName + '.xml ~ Finished ~~'"/>
               <debug_to_file directory="$DebugFolderName" name="$_DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n'"/>
            </do_if>

            <remove_value name="$_Sectors"/>
            <remove_value name="$_DebugScriptName"/>

         </actions>
      </library>
   </interrupts>
</aiscript>