<?xml version="1.0" encoding="utf-8"?>

<aiscript name="jp.lib.SD.IdleReturnHome" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd">

   <order id="JP_lib_SD_IdleReturnHome" name="IdleReturnHome" category="internal" infinite="false" allowinloop="false" canplayercancel="true">
      <params>
         <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
         <param name="IDLE_TIME"     type="internal" default="@this.ship.defaultorder.$IDLE_TIME"/>
         <param name="IDLE_MOVE_TO"  type="internal" default="@this.ship.defaultorder.$IDLE_MOVE_TO"/>
         <param name="WHERE_TO_MOVE" type="internal" default="@this.ship.defaultorder.$WHERE_TO_MOVE"/>
         <param name="IDLE_FOLLOW"   type="internal" default="@this.ship.defaultorder.$IDLE_FOLLOW"/>
         <param name="WHO_TO_FOLLOW" type="internal" default="@this.ship.defaultorder.$WHO_TO_FOLLOW"/>
         <param name="IDLE_DOCKING"  type="internal" default="@this.ship.defaultorder.$IDLE_DOCKING"/>
         <param name="FIND_STATION"  type="internal" default="@this.ship.defaultorder.$FIND_STATION"/>
         <param name="WHERE_TO_DOCK" type="internal" default="@this.ship.defaultorder.$WHERE_TO_DOCK"/>
         <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
         <param name="DEBUG" type="internal" default="@this.ship.defaultorder.$DEBUG"/>
         <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
      </params>
   </order>

   <interrupts>
      <handler ref="SectorChangeHandler"/>
      <handler ref="TargetInvalidHandler"/>
      <handler ref="AttackHandler"/>
      <handler ref="MissileLockHandler" />
      <handler ref="ScannedHandler"/>
      <handler ref="InspectedHandler"/>
      <handler ref="FoundAbandonedHandler"/>
      <handler ref="FoundLockboxHandler"/>
      <handler ref="ResupplyHandler"/>
      <handler ref="TideHandler"/>
   </interrupts>

   <init>
      <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
      <set_value name="$_Ship" exact="this.ship"/>
      <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
      <set_value name="global.$SD_IdleShips" exact="table[]" chance="(if not global.$SD_IdleShips? then 100 else 0)"/>
      <set_value name="global.$SD_IdleShips.{$_Ship}" exact="player.age"/>
      <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
      <do_if value="$DEBUG gt 0">
         <set_value name="$_DebugFolderName" exact="'JP_SatelliteDropper.logs'"/>
         <set_value name="$_DebugScriptName" exact="'jp.lib.SD.IdleReturnHome'"/>
         <set_value name="$_DebugFileName" exact="$_Ship.idcode + '.' + $_DebugScriptName + '.xml.log'"/>
      </do_if>
      <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
   </init>

   <attention min="unknown">
      <actions>

         <label name="INIT_LBL"/>
         <wait exact="1s"/>
         <do_if value="$DEBUG gt 0">
            <debug_to_file directory="$_DebugFolderName" name="$_DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'" append="false"/>
            <debug_to_file directory="$_DebugFolderName" name="$_DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ ' + $_DebugScriptName + '.xml ~ SCRIPT_START ~~' + '\n'"/>
         </do_if>

         <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

         <label name="IDLE_MOVE_TO_LBL"/>
         <wait exact="1s"/>
         <do_if value="$IDLE_MOVE_TO">
            <create_order object="$_Ship" id="'MoveWait'" immediate="true">
               <param name="destination" value="$WHERE_TO_MOVE"/>
               <param name="timeout" value="$IDLE_TIME"/>
            </create_order>
         </do_if>

         <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

         <label name="IDLE_FOLLOW_LBL"/>
         <wait exact="1s"/>
         <do_if value="$IDLE_FOLLOW">
            <do_if value="$WHO_TO_FOLLOW == null">
               <set_value name="$IDLE_MOVE_TO" exact="true"/>
               <resume label="IDLE_MOVE_TO_LBL"/>
            </do_if>
            <create_order object="$_Ship" id="'Follow'" immediate="true">
               <param name="target" value="$WHO_TO_FOLLOW"/>
            </create_order>
         </do_if>

         <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

         <label name="IDLE_DOCKING_LBL"/>
         <wait exact="1s"/>
         <do_if value="$IDLE_DOCKING">
            <do_if value="$WHERE_TO_DOCK == null or $FIND_STATION">
               <create_list name="$_FoundStations"/>
               <find_station name="$_FoundStations" sortbydistanceto="$_Ship" space="player.galaxy" multiple="true">
                  <match knownto="$_Ship.owner"/>
                  <match checkoperational="true"/>
                  <match_relation_to faction="$_Ship.owner" comparison="ge" relation="neutral"/>
               </find_station>
               <do_if value="$_FoundStations.count gt 0">
                  <do_for_each name="$_FoundStation" in="$_FoundStations">
                     <do_if value="$_FoundStation.dockingallowed.{$_Ship}">
                        <set_value name="$WHERE_TO_DOCK" exact="$_FoundStation"/>
                        <break/>
                     </do_if>
                  </do_for_each>
               </do_if>
            </do_if>
            <do_if value="$WHERE_TO_DOCK == null or not @$WHERE_TO_DOCK.dockingallowed.{$_Ship}">
               <set_value name="$IDLE_MOVE_TO" exact="true"/>
               <resume label="IDLE_MOVE_TO_LBL"/>
            </do_if>
            <create_order object="$_Ship" id="'DockAndWait'" immediate="true">
               <param name="destination" value="$WHERE_TO_DOCK"/>
               <param name="timeout" value="999h"/>
            </create_order>
            <wait exact="1s"/>
         </do_if>

         <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

         <label name="FINISH_LBL"/>
         <wait exact="1s"/>
         <do_if value="$DEBUG gt 0">
            <debug_to_file directory="$_DebugFolderName" name="$_DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ ' + $_DebugScriptName + '.xml ~ SCRIPT_END ~~'"/>
            <debug_to_file directory="$_DebugFolderName" name="$_DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n'"/>
         </do_if>

         <wait exact="1s"/>

      </actions>
   </attention>

   <on_abort>
   </on_abort>

</aiscript>